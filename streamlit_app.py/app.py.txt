import streamlit as st
import yfinance as yf
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime

st.set_page_config(layout="wide")
st.title("ğŸ“ˆ å°è‚¡æ¨¡æ“¬äº¤æ˜“ App")

# å¯é¸è‚¡ç¥¨
stocks = {
    'å°ç©é›»': '2330.TW',
    'é´»æµ·': '2317.TW',
    'è¯ç™¼ç§‘': '2454.TW',
    'å°é”é›»': '2308.TW',
    'å¯Œé‚¦é‡‘': '2881.TW'
}
stock_names = list(stocks.keys())

# session state åˆå§‹åŒ–
if "portfolio" not in st.session_state:
    st.session_state.portfolio = {}

# å·¦å´æ¬„ä½ - ä¸‹å–®æ“ä½œ
with st.sidebar:
    st.header("ğŸ›’ ä¸‹å–®æ“ä½œ")
    selected_stock = st.selectbox("é¸æ“‡è‚¡ç¥¨", stock_names)
    stock_symbol = stocks[selected_stock]
    quantity = st.number_input("è¼¸å…¥è‚¡æ•¸", min_value=1, value=100)
    action = st.radio("æ“ä½œ", ["è²·å…¥", "è³£å‡º"])

    stock_data = yf.Ticker(stock_symbol).info
    current_price = stock_data.get("regularMarketPrice", 0)

    if st.button("ç¢ºèªä¸‹å–®"):
        if selected_stock not in st.session_state.portfolio:
            st.session_state.portfolio[selected_stock] = {
                "symbol": stock_symbol,
                "quantity": 0,
                "avg_price": current_price
            }

        position = st.session_state.portfolio[selected_stock]
        if action == "è²·å…¥":
            total_cost = position["quantity"] * position["avg_price"] + quantity * current_price
            position["quantity"] += quantity
            position["avg_price"] = total_cost / position["quantity"]
            st.success(f"âœ… å·²è²·å…¥ {quantity} è‚¡ {selected_stock}")
        elif action == "è³£å‡º":
            if quantity > position["quantity"]:
                st.warning("âš ï¸ è³£å‡ºè‚¡æ•¸è¶…éæŒæœ‰æ•¸é‡")
            else:
                position["quantity"] -= quantity
                st.success(f"âœ… å·²è³£å‡º {quantity} è‚¡ {selected_stock}")
                if position["quantity"] == 0:
                    del st.session_state.portfolio[selected_stock]

# å³å´ä¸»é 
col1, col2 = st.columns([1, 2])

# å·¦å´é¡¯ç¤ºæŒè‚¡
with col1:
    st.subheader("ğŸ“¦ æˆ‘çš„æŠ•è³‡çµ„åˆ")
    if st.session_state.portfolio:
        for name, data in st.session_state.portfolio.items():
            live_price = yf.Ticker(data["symbol"]).info.get("regularMarketPrice", 0)
            total_value = data["quantity"] * live_price
            st.markdown(f"**{name}**")
            st.write(f"æŒè‚¡æ•¸é‡ï¼š{data['quantity']}")
            st.write(f"å¹³å‡æˆæœ¬ï¼š{data['avg_price']:.2f}")
            st.write(f"ç¾å€¼ï¼š${total_value:,.0f}")
            st.divider()
    else:
        st.info("å°šæœªæŒæœ‰ä»»ä½•è‚¡ç¥¨")

# å³å´é¡¯ç¤ºè‚¡åƒ¹åœ–èˆ‡å¤§ç›¤æŒ‡æ•¸
with col2:
    st.subheader(f"ğŸ“Š {selected_stock} èµ°å‹¢åœ–ï¼ˆè¿‘ä¸€å€‹æœˆï¼‰")
    df = yf.Ticker(stock_symbol).history(period="1mo")
    if not df.empty:
        fig, ax = plt.subplots()
        ax.plot(df.index, df["Close"])
        ax.set_xlabel("æ—¥æœŸ")
        ax.set_ylabel("æ”¶ç›¤åƒ¹")
        ax.set_title(f"{selected_stock}ï¼ˆ{stock_symbol}ï¼‰")
        ax.tick_params(axis='x', rotation=45)
        st.pyplot(fig)
    else:
        st.warning("æŸ¥ç„¡è³‡æ–™")

    st.subheader("ğŸ“‰ å°è‚¡å¤§ç›¤ (^TWII) æŒ‡æ•¸")
    twii = yf.Ticker("^TWII").history(period="1mo")
    if not twii.empty:
        fig2, ax2 = plt.subplots()
        ax2.plot(twii.index, twii["Close"], color='green')
        ax2.set_title("å°ç£åŠ æ¬Šè‚¡åƒ¹æŒ‡æ•¸ (è¿‘ä¸€æœˆ)")
        ax2.set_xlabel("æ—¥æœŸ")
        ax2.set_ylabel("æ”¶ç›¤åƒ¹")
        ax2.tick_params(axis='x', rotation=45)
        st.pyplot(fig2)
    else:
        st.warning("ç„¡æ³•è¼‰å…¥å¤§ç›¤è³‡æ–™")
